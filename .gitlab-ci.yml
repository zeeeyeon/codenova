stages:
  - docker set-up
  - deploy

docker setup:
  stage: docker set-up
  tags:
    - deploy
  only:
    - be/test/cicd

  before_script:
    - echo "$SSH_KEY" > timmy.pem
    - chmod 400 timmy.pem

  script:
    - |
      ssh -o StrictHostKeyChecking=no -i timmy.pem ubuntu@3.25.70.20 << 'EOF'
        if ! command -v docker &> /dev/null; then
          curl -fsSL https://get.docker.com | sudo sh
          sudo usermod -aG docker ubuntu
        fi

        if ! command -v docker-compose &> /dev/null; then
          OS=$(uname -s)
          ARCH=$(uname -m)
          sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-${OS}-${ARCH}" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
        fi
      EOF

deploy:
  stage: deploy
  tags:
    - deploy
  only:
    - be/test/cicd
  before_script:
    - echo "$SSH_KEY" > timmy.pem
    - chmod 400 timmy.pem
  script:
    - |
      ssh -o StrictHostKeyChecking=no -i timmy.pem ubuntu@3.25.70.20 << 'EOF'
        if [ ! -d /home/ubuntu/project ]; then
          git clone https://lab.ssafy.com/s12-final/S12P31E103.git /home/ubuntu/project
        fi

        cd /home/ubuntu/project
        git pull origin be/test/cicd
        docker-compose down || true
        docker-compose up -d --build
      EOF