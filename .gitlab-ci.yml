stages:
  - build-and-push
  - deploy

variables:
  DOCKER_DRIVER: overlay2

before_script:
  - echo "$SSH_KEY" > CodeNova.pem
  - chmod 400 CodeNova.pem

build-and-push:
  stage: build-and-push
  tags:
    - deploy
  only:
    - be/test/cicd
  script:
    - echo "ğŸ” AWS CLI ë¡œê·¸ì¸"
    - aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
    - aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
    - aws configure set default.region $AWS_REGION

    - echo "ğŸ”‘ ECR ë¡œê·¸ì¸"
    - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_BACKEND_REPO
    - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_FRONTEND_REPO

    - echo "ğŸ“¦ ë°±ì—”ë“œ Docker ë¹Œë“œ & í‘¸ì‹œ (Gradle ë¹Œë“œ í¬í•¨)"
    - docker build -t $ECR_BACKEND_REPO:latest ./Backend
    - docker push $ECR_BACKEND_REPO:latest

    - echo "ğŸ¨ í”„ë¡ íŠ¸ì—”ë“œ Docker ë¹Œë“œ & í‘¸ì‹œ (React ë¹Œë“œ í¬í•¨)"
    - docker build -t $ECR_FRONTEND_REPO:latest ./Front/codenova
    - docker push $ECR_FRONTEND_REPO:latest

deploy:
  stage: deploy
  tags:
    - deploy
  only:
    - be/test/cicd
  script:
    - echo "ğŸš€ EC2ì—ì„œ ì‹¤í–‰"
    - |
      ssh -o StrictHostKeyChecking=no -i CodeNova.pem ubuntu@3.25.70.20 << EOF
        echo "ğŸ”‘ ECR ë¡œê·¸ì¸ on EC2"
        aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_BACKEND_REPO
        aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_FRONTEND_REPO

        echo "ğŸ“¥ ì´ë¯¸ì§€ pull"
        docker pull $ECR_BACKEND_REPO:latest
        docker pull $ECR_FRONTEND_REPO:latest

        echo "ğŸ§¹ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬"
        docker stop backend || true && docker rm backend || true
        docker stop frontend || true && docker rm frontend || true

        echo "ğŸš€ ì»¨í…Œì´ë„ˆ ì‹¤í–‰"
        docker run -d --name backend -p 8080:8080 $ECR_BACKEND_REPO:latest
        docker run -d --name frontend -p 3000:80 $ECR_FRONTEND_REPO:latest
      EOF