stages:
  - build
  - push
  - deploy

variables:
  DOCKER_DRIVER: overlay2

before_script:
  - echo "$SSH_KEY" > K12E103T.pem
  - chmod 400 K12E103T.pem

frontend-build-and-push:
  stage: build
  tags:
    - deploy
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
      when: always
  script:
    - echo "ECR 로그인"
    - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_FRONTEND_REPO

    - echo "프론트 빌드"
    - docker build -t $ECR_FRONTEND_REPO:latest ./Front/codenova
    - docker push $ECR_FRONTEND_REPO:latest

backend-build-and-push:
  stage: build
  tags:
    - deploy
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop-be"'
      when: always
  script:
    - echo "ECR 로그인"
    - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_BACKEND_REPO

    - echo "백엔드 빌드"
    - docker build -t $ECR_BACKEND_REPO:latest ./Backend
    - docker push $ECR_BACKEND_REPO:latest

deploy-frontend:
  stage: deploy
  tags:
    - deploy
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
      when: always
  script:
    - echo "EC2 SSH 접속 후 Pull & Run (Frontend)"
    - |
      ssh -o StrictHostKeyChecking=no -i K12E103T.pem ubuntu@$EC2_HOST << EOF
        aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_FRONTEND_REPO
      
        docker pull $ECR_FRONTEND_REPO:latest || true
        docker stop frontend || true && docker rm frontend || true
        docker run -d --name frontend -p 3000:3000 $ECR_FRONTEND_REPO:latest
      EOF

deploy-backend:
  stage: deploy
  tags:
    - deploy
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop-be"'
      when: always
  script:
    - echo "EC2 SSH 접속 후 Pull & Run (Backend)"
    - |
      ssh -o StrictHostKeyChecking=no -i K12E103T.pem ubuntu@$EC2_HOST << EOF
        aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_BACKEND_REPO
      
        docker pull $ECR_BACKEND_REPO:latest || true
        docker stop backend || true && docker rm backend || true
      
        mkdir -p ~/config
        echo "$APPLICATION_YML" > ~/config/application.yml
      
        docker run -d --name backend -p 8080:8080 -p 9092:9092 \
          --network codenova-network \
          -v ~/config/application.yml:/app/config/application.yml \
          -e SPRING_CONFIG_LOCATION=file:/app/config/application.yml \
          $ECR_BACKEND_REPO:latest
      EOF
